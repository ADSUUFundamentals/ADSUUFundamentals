---
title: "Practical 3"
author: "Kyle M. Lang"
date: "Fundamental Techniques in Data Science with R"
params:
  answers: true
output: 
   html_document:
    toc: true
    toc_depth: 1
    toc_float: true
    number_sections: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 18px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r, echo = FALSE}
knitr::opts_chunk$set(include = params$answers, echo = params$answer)
```

---

Begin this practical by setting the maximum line length in R-Studio to 80 
characters. 

1. Go to *Preferences* (or *Global Options* under *Tools*) --> *Code* --> 
*Display*.
1. Tick the *Show margin* box. 
1. Set the *Margin column* to *80*.

---

# Data I/O

---

##

**Install the *mice* package**

Use the `install.packages()` function to install the  the **mice** package.

```{r, eval = FALSE}
install.packages("mice")
```

```{asis}
If all went well, you will receive a message in the console telling you that the 
package has been installed. 
```

---

##

**Load the *mice* package**

Use the `library()` function to load installed packages.

- Installing the package only makes the package available on your machine.
- You have to load the package every time you want to use it in a new R session.

```{r}
library(mice)
```

---

##

**View the `mammalsleep` data**

Most packages have datasets included. Open the `mammalsleep` dataset from the 
**mice** package in two ways:

1. By evaluating its name, `mammalsleep`, directly
1. By using the `View()` function

```{r, eval = FALSE}
## I'm not actually running these lines because the results would clutter 
## this document too much.
mammalSleep
View(mammalSleep)
```

```{asis}
Using `View()` is preferred for inspecting large datasets because `View()` opens 
the dataset in a spreadsheet-like window. 
```

---

##

**Write the `mammalsleep` dataset to disk**

Save the `mammalsleep` dataset that you viewed above to your working directory. 

- Save the data as a tab-delimited text file.
- Use the `.` character as the decimal seperator. 
- Name the file `mammalsleep.txt`

```{r}
write.table(mammalsleep, 
            file = "mammalsleep.txt", 
            sep = "\t", 
            dec = ".", 
            row.names = FALSE)
```

```{asis}
- The command `sep = "\t"` creates a tab-delimited file
- The command `dec = "."` specifies the `.` character as the decimal seperator 
(instead of a comma). 
- The command `row.names = FALSE` tells R not to include row names in the 
exported file. 
```

---

##

**Read the `mammalsleep.txt` file from disk**

Read in the data that you just saved to disk and save it as a new R object 
called `sleepdata`.

```{r}
sleepdata <- read.table("mammalsleep.txt", 
                        sep = "\t", 
                        dec = ".", 
                        header = TRUE, 
                        stringsAsFactors = TRUE)
```

- The command `sep = "\t"` indicates that the file is tab-delimited
- The command `dec = "."` indicates that a `.` is used as the decimal seperator
- The command `header = TRUE` tells R that the first row of data contains the 
variable names
- The `stringsAsFactors = TRUE` command will automatically convert any character 
variables to factors

You can read files that live in the working directory by specifying only the 
file name (with the file extension). To read files that live in any other 
location, you need to specify the full file path (either relative to the working 
directory or an absolute path). To find the current working directory, you can 
run `getwd()`. To change the working directory, you can use `setwd()`. One 
benefit of using RStudio projects is that the working directory is automatically 
set to the main project directory. 

There are many packages that facilitate data I/O from other statistical software 
packages such as SPSS (e.g. `read_spss()` from the **haven** package), Mplus 
(routines in the **MplusAutomation** package), Stata (`read.dta()` in the 
**foreign** package), SAS (`sasxport.get()` from the **Hmisc** package). There 
are also packages to read data from spreadsheet software such as MS Excel 
(`read.xlsx()` from the `xlsx` package). For a short guide on importing multiple 
file formats into R, see 
[this page](http://www.statmethods.net/input/importingdata.html).

---

## Exercise 6-10

---

6. **The dataset we've just imported contains the sleepdata by Allison & Cicchetti (1976). Inspect the sleepdata and make yourself familiar with it. **

If you would like to know more about this dataset, you can open the help for the `mammalsleep` dataset in package **mice** through `?mammalsleep`. Don't forget to load package **mice** first. 

Inspecting the sleepdata could be done by 
```{r}
str(sleepdata) #the data structure
summary(sleepdata) #distributional summaries
round(cor(sleepdata[, -1], use = "pairwise.complete.obs"), 2) #bivariate correlations, variable 1 excluded. 
head(mammalsleep) #first six rows
tail(mammalsleep) #last six rows
?mammalsleep # the help
```
Note that the sleepdata dataset is automatically recognized as a dataframe. After all, there is one factor (categorical variable) containing the animal names. 

The functions `head()` and `tail()` are very useful functions. As is function `str` as it gives you a quick overview of the measurement levels in `mammalsleep`. 

Since `mammalsleep` is an R-dataset, there should be a help file. Taking a look at `?mammalsleep` may yield valuable insight about the measurements and origin of the variables. 

One thing that may have caught your attention is the relation between `ts`, `ps` and `sws`. This is a deterministic relation where total sleep (`ts`) is the sum of paradoxical sleep (`ps`) and short-wave sleep (`sws`). In the event that you would model the data, you need to take such relations into account. 

---

7. **Save the current workspace. Name the workspace `Practical_C.RData`. Also, save the sleepdata file as a separate workspace called `Sleepdata.RData`. **

Now that we have imported our data, it may be wise to save the current workspace, i.e. the current state of affairs. Saving the workspace will leave everything as is, so that we can continue from this exact state at a later time, by simply opening the workspace file. To save everything in the current workspace, type
```{r}
save.image("Practical_C.RData")
```

To save just the dataset `sleepdata`, and nothing else, type
```{r}
save(sleepdata, file = "Sleepdata.RData")
```

With the save functions, any object in the workspace can be saved. 

---

8. **Some animals were not used in the calculations by Allison and Cicchetti. Exclude the following animals from the sleepdata dataset: Echidna, Lesser short-tailed shrew and Musk shrew. Save the dataset as sleepdata2.** Tip: use the square brackets to indicate [rows, columns].

There are three ways to exclude the three animals from the dataset. The first approach uses the names:
```{r}
exclude <- c("Echidna", "Lesser short-tailed shrew", "Musk shrew")
which <- sleepdata$species %in% exclude #Indicate the species that match the names in exclude
which
sleepdata2 <- sleepdata[!which, ]
```

the second approach uses function `filter()` from package `dplyr`:
```{r}
library(dplyr) # Data Manipulation
filter(sleepdata, !sleepdata$species %in% exclude) # ! makes all TRUES into FALSE
```

and the third approach uses the row numbers directly (you would need to inquire about, or calculate the rownumbers)
```{r}
sleepdata2 <- sleepdata[-c(16, 32, 38), ]
```

Note that the numbered option requires less code, but the named option has a much lower probability for error. As the dataset might change, or might get sorted differently, the second option may not be valid anymore. 

---

9. **Plot brain weight as a function of species. **
```{r}
plot(brw ~ species, data = sleepdata2)
```

---

10. **Some animals have much heavier brains than other animals. Find out the names of the animals that have a brain weight larger than 1 standard deviation above the mean brain weight. Replicate the plot from Question 9 with only these animals and do not plot any information about the other animals. **

To find out which animals have a brain weight larger than 1 standard deviation above the mean brain weight:
```{r}
sd.brw <- sd(sleepdata2$brw) #standard deviation  
mean.brw <- mean(sleepdata2$brw) #mean
which <- sleepdata2$brw > (mean.brw + (1 * sd.brw)) #which are larger?
as.character(sleepdata2$species[which]) #names of the animals with brw > 1000
```
To plot these animals:
```{r}
plot(brw ~ species, data = sleepdata2[which, ])
```

The downside is that it still prints all the animals on the x-axis. This is due to the factor labels for `species` being copied to the smaller subset of the data. Plot automatically takes over the labels. For example, 
```{r}
sleepdata2$species[which]
```

returns only 3 mammals, but still has 62 factor levels. To get rid of the unused factor levels, we can use function `factor()`:
```{r}
sleepdata3 <- sleepdata2[which, ]
sleepdata3$species <- factor(sleepdata3$species)
sleepdata3$species
```
To plot the graph that we wanted:
```{r}
plot(brw ~ species, data = sleepdata3)
```

---

If your current software-analysis platform is different from R, chances are that you prepare your data in the software of your choice. In R there are fantastic facilities for importing and exporting data and I would specifically like to pinpoint you to package [`haven`](https://haven.tidyverse.org/index.html) by [Hadley Wickham](http://hadley.nz). It provides wonderful functions to import and export many data types from software such as Stata, SAS and SPSS.

---

# Useful links 

- [`Package haven`](https://haven.tidyverse.org/index.html) for importing/exporting `SPSS`, `SAS` and `STATA` data.

---

End of exercise 

---



